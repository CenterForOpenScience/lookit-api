{% load bootstrap3 %}

<script>

    // Show the generator function field only if use_generator is checked.
    function updateGeneratorDisplay() {
        if ($('#id_use_generator')[0].checked) {
            $('#generator-container').show();
        } else {
            $('#generator-container').hide();
        }
    }

    // Display an error if generator is not a valid JS function. Returns 0 if no errors, 1 if errors.
    function validateGenerator(code) {
        var $errorDisplay = $('#validation-error-generator');
        $errorDisplay.hide();
        try {
            var generator = Function(code)();
            try {
                var generatorFn = Function('return ' + code)();
                if (typeof generatorFn !== 'function') {
                    throw new Error();
                }
            } catch (error) {
                $errorDisplay.text('Warning: Generator function does not evaluate to a single function. Generator will be disabled if this value is saved.');
                $errorDisplay.show();
                return 1;
            }
        } catch (error) {
            $errorDisplay.text('Warning: Invalid Javascript. Generator will be disabled if this value is saved.');
            $errorDisplay.show();
            return 1;
        }
        return 0;
    }

    // Display an error if structure is not a valid JSON string. Returns 0 if no errors, 1 if errors.
    function validateStructure(code) {
        var $errorDisplay = $('#validation-error-structure');
        $errorDisplay.hide();
        try {
            var struct = JSON.parse(code);
        } catch (error) {
            $errorDisplay.text('Warning: Invalid JSON.');
            $errorDisplay.show();
            return 1;
        }
        return 0;
    }

    $(document).ready(function() {

        // Do initial validation of structure, generator.
        validateStructure($('#id_structure').val());
        validateGenerator($('#id_generator').val());

        // When use_generator field changes, update whether generator field is displayed
        updateGeneratorDisplay();
        $('#id_use_generator').on('change', function() {
            updateGeneratorDisplay();
        });

        // Validate generator function upon closing its editor
        $("#generator-container .ace-overlay .save, #generator-container .ace-overlay .cancel").bind("click", function (event) {
            // data field 'editor' bound to editor but only while editor is open
            var code = $('#generator-container .ace-overlay').data('editor').getValue();
            validateGenerator(code);
        });

        // Validate structure function upon closing its editor
        $("#structure-container .ace-overlay .save, #generator-container .ace-overlay .cancel").bind("click", function (event) {
            // data field 'editor' bound to editor but only while editor is open
            var code = $('#structure-container .ace-overlay').data('editor').getValue();
            validateStructure(code);
        });

        // Use ctrl-S to save study from either editor.
        $(".ace-overlay .edit").bind("click", function (event) {
            var $aceOverlay = $(this).closest('.ace-overlay')
            var editor = $aceOverlay.data('editor');
            editor.commands.addCommand({
                name: 'save',
                bindKey: {win: 'Ctrl-S', mac: 'Command-S'},
                exec: function(editor) {
                    $aceOverlay.find('.save').click();
                    // Could also consider triggering save button on broader form
                },
                readOnly: false // should not apply in readOnly mode
            });
        });

        // Upon submit, unset use generator if generator function is invalid
        $("#create-study-button, #save-button").bind("click", function(event) {
            if (validateGenerator($('#id_generator').val())) {
                $('#id_use_generator').prop("checked", false);
                $('#id_use_generator')[0].value = false;
            }
        });

    });
</script>

{% bootstrap_form_errors form %}
{% bootstrap_field form.name %}
{% bootstrap_field form.public %}
{% bootstrap_field form.shared_preview %}
{% bootstrap_field form.image %}
{% bootstrap_field form.short_description %}
{% bootstrap_field form.long_description %}
{% bootstrap_field form.compensation_description %}
{% bootstrap_field form.exit_url %}
{% bootstrap_field form.criteria %}
{% bootstrap_field form.criteria_expression %}
<div class="row">
    <div class="col-xs-12">
        <label class="control-label">Minimum Age Cutoff</label>
        <p class="help-block"> This and the maximum age cutoff are used to check eligibility for studies; families who select a child outside the age range see a warning indicating that their data may not be used. The child's age in days is compared to these (inclusive) min and max ages (computed as years * 365 + months * 30 + days) to check eligibility. </p>
    </div>
    <div class="col-xs-2">
        <div class="form-group">
            <label class="control-label" for="id_min_age_years"><em>Year(s)</em></label>
            <select name="min_age_years" class="form-control" title="" id="id_min_age_years">
                {% for x, y in form.fields.min_age_years.choices %}
                    <option value="{{ x }}"{% if study.min_age_years == x %} selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-xs-2">
        <div class="form-group">
            <label class="control-label" for="id_min_age_months"><em>Month(s)</em></label>
            <select class="form-control" id="id_min_age_months" name="min_age_months" title="">
                {% for x, y in form.fields.min_age_months.choices %}
                    <option value="{{ x }}"{% if study.min_age_months == x %} selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-xs-2">
        <div class="form-group">
            <label class="control-label" for="id_min_age_days"><em>Day(s)</em></label>
            <select class="form-control" id="id_min_age_days" name="min_age_days" title="">
                {% for x, y in form.fields.min_age_days.choices %}
                    <option value="{{ x }}"{% if study.min_age_days == x %} selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-xs-12">
        <label class="control-label">Maximum Age Cutoff</label>
    </div>
    <div class="col-xs-2">
        <div class="form-group">
            <label class="control-label" for="id_max_age_years"><em>Year(s)</em></label>
            <select name="max_age_years" class="form-control" title="" id="id_max_age_years">
                {% for x, y in form.fields.max_age_years.choices %}
                    <option value="{{ x }}"{% if study.max_age_years == x %} selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-xs-2">
        <div class="form-group">
            <label class="control-label" for="id_max_age_months"><em>Month(s)</em></label>
            <select class="form-control" id="id_max_age_months" name="max_age_months" title="">
                {% for x, y in form.fields.max_age_months.choices %}
                    <option value="{{ x }}"{% if study.max_age_months == x %} selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="col-xs-2">
        <div class="form-group">
            <label class="control-label" for="id_max_age_days"><em>Day(s)</em></label>
            <select class="form-control" id="id_max_age_days" name="max_age_days" title="">
                {% for x, y in form.fields.max_age_days.choices %}
                    <option value="{{ x }}"{% if study.max_age_days == x %} selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>
{% bootstrap_field form.duration %}
{% bootstrap_field form.contact_info %}
{% bootstrap_field form.lab %}
<div id="structure-container">
    {% bootstrap_field form.structure %}
    <p class="form-validation-error" id="validation-error-structure"> </p>
</div>
{% bootstrap_field form.use_generator %}
<div id="generator-container">
    {% bootstrap_field form.generator %}
    <p class="form-validation-error" id="validation-error-generator"> </p>
</div>
